server {
    listen ${PORT};
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Character encoding
    charset utf-8;

    # Enable gzip compression (2025 best practices)
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/woff
        font/woff2;

    # Disable gzip for IE6 and older
    gzip_disable "msie6";

    # Main location block for presentations
    location / {
        # Rewrite .md URLs to .html files (MARP generates .md links but builds .html files)
        rewrite ^/(.+)\.md$ /$1.html last;

        # Try to serve file directly, fall back to .html extension, then 404
        try_files $uri $uri.html $uri/ =404;

        # CORS headers (if presentations need to be embedded)
        # Uncomment if needed:
        # add_header Access-Control-Allow-Origin "*" always;
        # add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    }

    # HTML files - no caching (presentations may be updated)
    location ~* \.html?$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
    }

    # Cache static assets (CSS, JS, fonts, images)
    location ~* \.(css|js|woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Image files - long-term caching
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Security headers (2025 recommendations)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Content Security Policy for presentations
    # Adjust based on your presentation content (inline styles, external resources)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; object-src 'none'; frame-ancestors 'self';" always;

    # Disable server tokens for security
    server_tokens off;

    # Custom error pages (optional)
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    # Deny access to hidden files (e.g., .git, .env)
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Health check endpoint for container orchestration
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
