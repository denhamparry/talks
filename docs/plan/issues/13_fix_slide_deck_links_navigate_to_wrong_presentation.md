# GitHub Issue #13: Fix: Slide deck links navigate to wrong presentation

**Issue:** [#13](https://github.com/denhamparry/talks/issues/13)
**Status:** Open
**Date:** 2025-12-03
**Labels:** bug, presentation, routing, priority:high

## Problem Statement

When viewing the presentation list at `localhost:8080`, clicking on a slide deck link navigates to the wrong presentation instead of the selected one. This affects the core functionality of browsing and viewing presentations from the index page.

### Current Behavior

1. The MARP server generates an index page at `http://localhost:8080/`
2. The index lists slide deck links using markdown file references (e.g., `href="example-contribution.md"`)
3. When a user clicks on a link, MARP's dev server correctly serves the HTML presentation from the `.md` URL
4. However, the production nginx configuration expects different URL patterns

### Expected Behavior

Clicking on any slide deck link from the index page should navigate to the correct presentation file, consistently across both development (MARP server) and production (nginx) environments.

### Root Cause

**Routing mismatch between development and production:**

1. **MARP dev server behavior** (`npm run serve`):
   - Generates index with links: `<a href="example-contribution.md">example-contribution.md</a>`
   - Serves HTML presentation when accessing `.md` URLs
   - Works correctly in development

2. **Production nginx configuration** (nginx.conf:35):
   ```nginx
   try_files $uri $uri.html $uri/ =404;
   ```
   - Tries to serve `/example-contribution.md` (raw markdown file)
   - Then tries `/example-contribution.md.html` (doesn't exist)
   - Falls back to 404 or serves wrong content

3. **URL pattern inconsistency:**
   - MARP builds to: `dist/example-contribution.html`
   - Index links to: `example-contribution.md`
   - nginx can't map `.md` URLs to `.html` files

## Current State Analysis

### Relevant Files

**1. MARP Development Server**
- **Script:** `package.json:14` - `"serve": "marp -s -I slides/"`
- **Behavior:** Auto-generates index with `.md` links, serves HTML from `.md` URLs
- **Works correctly** in development

**2. Production Server Configuration**
- **File:** `nginx.conf`
- **Lines 32-41:** Main location block
  ```nginx
  location / {
      try_files $uri $uri.html $uri/ =404;
  }
  ```
- **Issue:** Doesn't handle `.md` → `.html` URL mapping

**3. Docker Build Process**
- **File:** `Dockerfile`
- **Lines 31-36:** Build stage builds HTML slides
  ```dockerfile
  RUN sed -i "s/pdf: true,/pdf: false,/" marp.config.js
  RUN npm run build
  ```
- **Lines 86-87:** Copies built slides to nginx
  ```dockerfile
  COPY --from=builder /app/dist /usr/share/nginx/html
  ```

**4. Build Configuration**
- **File:** `marp.config.js:9`
- **Output directory:** `./dist`
- **File:** `package.json:11`
- **Build command:** `"build": "marp -I slides/ -o dist/"`
- **Output format:** HTML files (e.g., `example-contribution.html`)

### Environment Comparison

| Aspect | Development | Production |
|--------|-------------|------------|
| Server | MARP dev server (Node) | nginx (static) |
| Port | 8080 | 80 |
| Index | Auto-generated by MARP | Static from dist/ |
| Links | `.md` URLs | `.md` URLs |
| URL handling | MARP resolves `.md` → HTML | nginx tries literal `.md` file |
| Result | ✅ Works | ❌ Broken |

## Solution Design

### Approach

Fix the nginx configuration to handle MARP's URL pattern by adding a rewrite rule that maps `.md` URLs to `.html` files. This approach:

1. **Maintains compatibility** with MARP's generated index
2. **Minimal changes** - only nginx config modification
3. **No build process changes** required
4. **Preserves development experience** - dev server continues working as-is

### Alternative Approaches Considered

1. **Modify MARP index generation** ❌
   - Not possible - MARP CLI doesn't offer configuration for index link format
   - Would require forking/patching MARP

2. **Post-process index.html** ❌
   - Adds complexity to build process
   - Fragile - breaks if MARP changes index format
   - Requires maintaining sed/awk scripts

3. **Use nginx rewrite rules** ✅
   - Simple, maintainable solution
   - Centralized in one config file
   - Follows nginx best practices

### Implementation

**Add nginx rewrite rule before `try_files` directive:**

```nginx
location / {
    # Rewrite .md URLs to .html files
    rewrite ^/(.+)\.md$ /$1.html last;

    # Try to serve file directly, fall back to .html extension, then 404
    try_files $uri $uri.html $uri/ =404;
}
```

**How it works:**
1. User clicks link: `href="example-contribution.md"`
2. Browser requests: `GET /example-contribution.md`
3. nginx rewrite: `/example-contribution.md` → `/example-contribution.html`
4. nginx try_files: Serves `/usr/share/nginx/html/example-contribution.html`
5. User sees correct presentation

### Benefits

- ✅ Fixes routing issue with single config change
- ✅ No build process modifications needed
- ✅ Maintains dev/prod parity in user experience
- ✅ Simple, testable solution
- ✅ Follows nginx conventions

## Implementation Plan

### Step 1: Update nginx configuration

**File:** `nginx.conf`

**Changes:**
Add rewrite rule before `try_files` directive in the main location block (line 32).

**Before:**
```nginx
    # Main location block for presentations
    location / {
        # Try to serve file directly, fall back to .html extension, then 404
        try_files $uri $uri.html $uri/ =404;
        ...
    }
```

**After:**
```nginx
    # Main location block for presentations
    location / {
        # Rewrite .md URLs to .html files (MARP generates .md links but builds .html files)
        rewrite ^/(.+)\.md$ /$1.html last;

        # Try to serve file directly, fall back to .html extension, then 404
        try_files $uri $uri.html $uri/ =404;
        ...
    }
```

**Testing:**
```bash
# Rebuild production container
docker compose build prod

# Start production server
docker compose --profile production up prod

# Test in browser or curl
curl -I http://localhost:8081/example-contribution.md
# Should return 200 OK and serve HTML content

curl http://localhost:8081/example-contribution.md | grep "<!DOCTYPE html>"
# Should output HTML doctype, confirming HTML is served

# Test index page
curl -s http://localhost:8081/ | grep "example-contribution.md"
# Should show links with .md extension

# Click test (manual in browser)
# 1. Open http://localhost:8081/
# 2. Click on any presentation link
# 3. Verify correct presentation loads
```

### Step 2: Verify production build

**Build and test production Docker image:**

```bash
# Build production stage
docker compose build prod

# Run production container
docker compose --profile production up -d prod

# Check container health
docker compose ps

# Check nginx logs for errors
docker compose logs prod
```

**Expected results:**
- Container builds successfully
- Health check passes
- No nginx configuration errors in logs

### Step 3: End-to-end testing

**Test Case 1: Index page loads**
1. Navigate to `http://localhost:8081/`
2. Verify index page displays with presentation list
3. Verify links contain `.md` extension

**Expected:** Index page loads, links show as `example-contribution.md`

**Test Case 2: Click presentation link**
1. From index page, click "example-contribution.md"
2. Verify browser navigates to `/example-contribution.md`
3. Verify correct presentation HTML loads
4. Verify presentation displays properly (not raw markdown)

**Expected:** Presentation loads and displays correctly

**Test Case 3: Direct URL access**
1. Navigate directly to `http://localhost:8081/example-presentation.md`
2. Verify presentation loads

**Expected:** Presentation loads via direct URL

**Test Case 4: Alternative presentation link**
1. From index, click "example-presentation.md"
2. Verify correct presentation loads (not example-contribution)

**Expected:** Each link loads its own presentation, not a different one

**Test Case 5: PDF and PPTX links (if present)**
1. Check if PDF/PPTX links work
2. These use query parameters: `example-contribution.md?pdf`

**Expected:** Links work if PDF generation is enabled

## Testing Strategy

### Unit Testing (Manual)

**nginx configuration validation:**
```bash
# Test nginx config syntax
docker compose run --rm prod nginx -t

# Expected output:
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test successful
```

### Integration Testing

**Test Case 1: Development server (baseline)**
```bash
# Start dev server
npm run serve

# Open http://localhost:8080/
# Click each presentation link
# Verify all links work correctly
```

**Expected:** All links work in development (baseline)

**Test Case 2: Production server (fix validation)**
```bash
# Build and start production
docker compose build prod
docker compose --profile production up -d prod

# Test index
curl -s http://localhost:8081/ | grep -o 'href="[^"]*\.md"'

# Test each presentation link
for slide in example-contribution example-presentation; do
  echo "Testing $slide.md..."
  curl -s "http://localhost:8081/$slide.md" | grep -q "<!DOCTYPE html" && echo "✅ $slide works" || echo "❌ $slide broken"
done
```

**Expected:** All tests show ✅ with correct HTML served

**Test Case 3: Regression test (verify existing functionality)**
```bash
# Test root index
curl -I http://localhost:8081/
# Expected: 200 OK

# Test direct HTML access (should still work)
curl -I http://localhost:8081/example-contribution.html
# Expected: 200 OK

# Test non-existent file
curl -I http://localhost:8081/nonexistent.md
# Expected: 404 Not Found

# Test health endpoint
curl http://localhost:8081/health
# Expected: "healthy"
```

**Expected:** All existing functionality continues working

### Regression Testing

**Verify no side effects:**

1. **Static asset serving** still works:
   ```bash
   # Test CSS, JS, fonts (if any exist in dist/)
   curl -I http://localhost:8081/path/to/style.css
   ```

2. **Error pages** still work:
   ```bash
   curl -I http://localhost:8081/nonexistent
   # Should return 404
   ```

3. **Security headers** still applied:
   ```bash
   curl -I http://localhost:8081/ | grep -E "X-Frame-Options|X-Content-Type-Options|Content-Security-Policy"
   ```

4. **Gzip compression** still enabled:
   ```bash
   curl -H "Accept-Encoding: gzip" -I http://localhost:8081/ | grep "Content-Encoding: gzip"
   ```

## Success Criteria

- [ ] nginx configuration updated with rewrite rule
- [ ] nginx configuration passes syntax validation (`nginx -t`)
- [ ] Production Docker image builds successfully
- [ ] Container health check passes
- [ ] Index page loads at `http://localhost:8081/`
- [ ] All presentation links on index page work correctly
- [ ] Each link navigates to correct presentation (not wrong one)
- [ ] Direct URL access to `.md` URLs works
- [ ] Direct URL access to `.html` URLs continues working (backward compatibility)
- [ ] 404 errors for non-existent files work correctly
- [ ] No nginx errors in container logs
- [ ] Development server continues working unchanged
- [ ] All regression tests pass (security headers, compression, error pages)

## Files Modified

1. **nginx.conf** - Add rewrite rule to map `.md` URLs to `.html` files
   - Lines 32-41: Main location block
   - Add: `rewrite ^/(.+)\.md$ /$1.html last;`

## Related Issues and Tasks

### Blocks

- User experience in production deployment
- Ability to browse presentations from index page
- Core functionality of presentation hosting

### Related

- [Issue #8](https://github.com/denhamparry/talks/issues/8) - Docker containerization (implementation)
- nginx.conf - Created during Docker containerization effort
- MARP build process - Generates HTML from markdown

### Enables

- Consistent development/production experience
- Reliable presentation browsing
- Deployment to production environments

## References

- [GitHub Issue #13](https://github.com/denhamparry/talks/issues/13)
- [nginx rewrite module docs](http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite)
- [nginx try_files docs](http://nginx.org/en/docs/http/ngx_http_core_module.html#try_files)
- [MARP CLI documentation](https://github.com/marp-team/marp-cli)

## Notes

### Key Insights

1. **Development vs Production gap:** MARP's dev server has intelligent URL handling that static nginx doesn't replicate
2. **URL pattern design:** MARP generates `.md` links because that's what it indexes, but builds `.html` files
3. **Rewrite before try_files:** nginx processes rewrite rules before try_files, making this a clean solution
4. **last flag:** Using `last` flag in rewrite creates a new internal request, allowing try_files to process the rewritten URL

### Best Practices

1. **Test nginx config before deployment:**
   ```bash
   docker compose run --rm prod nginx -t
   ```

2. **Monitor nginx logs during testing:**
   ```bash
   docker compose logs -f prod
   ```

3. **Use curl for automated testing:**
   ```bash
   curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/example-contribution.md
   ```

4. **Consider adding nginx access logs for debugging:**
   ```nginx
   access_log /var/log/nginx/access.log;
   error_log /var/log/nginx/error.log debug;
   ```

### Alternative Approaches Considered (Details)

1. **Modify MARP build command** ❌
   - Tried: Custom output paths, different formats
   - Problem: MARP always generates `.md` links in index
   - Conclusion: Not configurable via CLI flags

2. **Use symbolic links** ❌
   - Tried: Create `.md` symlinks to `.html` files
   - Problem: Doesn't work in Docker, complex in build
   - Conclusion: Overly complex, platform-dependent

3. **JavaScript redirect in index** ❌
   - Tried: Add client-side URL rewriting
   - Problem: Requires modifying MARP's generated index
   - Conclusion: Breaks on page refresh, bad UX

4. **nginx try_files pattern** ✅ **Chosen approach**
   - Simple rewrite rule handles URL mapping
   - Centralized, server-side solution
   - No build process changes
   - Standard nginx pattern

### Monitoring Recommendations

After deployment, monitor:

1. **nginx access logs** for 404s on `.md` URLs
2. **Response times** to ensure rewrite doesn't impact performance (it won't - rewrites are fast)
3. **User reports** of navigation issues

### Future Improvements

1. **Custom index page:** Create custom index HTML that links directly to `.html` files
   - Pros: No nginx rewrites needed
   - Cons: Have to maintain separate index

2. **MARP configuration:** Contribute to MARP CLI to make index link format configurable
   - Pros: Fixes root cause
   - Cons: Requires upstream changes, long timeline

3. **Build script:** Add post-build step to rewrite index.html links
   - Pros: Clean URLs without nginx rewrites
   - Cons: Adds build complexity
